<div class="row element-style">
  <div class="col-md-8 col-md-offset-2">
    <div id="errorTagCont" class="'has-error alert alert-danger alert-dismissable'">
      <button name="button" type="button" onclick="$('#errorTagCont').hide();" class="close">×</button>
      <div id="errorTag"></div>
    </div>
    <% if @errors %>
      <% @errors.each do |error| %>
        <div class="'has-error alert alert-danger alert-dismissable'">
          <button name="button" type="button" class="close" data-dismiss="alert">×</button>
          <%= error %>
        </div>
      <% end%>
    <% end%>
    <div class="row">
      <legend class="col-lg-12"><%= @position.unit.campaign.name %></legend>
      </div>
      <button class="accordion">Instrucciones de cumplimentación de la encuesta</button>
      <div class="panel-instructions">
        <table class="table table-striped table-hover ">
          <tbody>
            <tr>
              <td>Instrucción 1. Responder todas las preguntas con un valor numérico.</td>
            </tr>
            <tr>
              <td>Instrucción 2. La suma de las respuestas debe ser igual a 100, ya que se trata de porcentajes.</td>
            </tr>
            <tr>
              <td>Instrucción 3. Se pueden añadir hasta tres tareas extra, proporcionando su descripción.</td>
            </tr>
          </tbody>
        </table>
      </div>
    <form action="/surveys/create" method="POST">
      <fieldset>
        <!--<div class="per-bar">
          <h5><b>Tiempo restante: <%= @total_per %>%</b></h5>
          <div class="progress progress-striped">
            <div class="progress-bar progress-bar-success" style="width: <%= @total_per %>%"></div>
          </div>
        </div>-->
  
        <div class="form-group">
          <div class="row question-mark">
            <h4 class="col-lg-12 control-label question">¿En qué ha destinado el tiempo el último trimestre?</h4>
          </div>
          <div class="row">
            <table class="table table-striped table-hover ">
              <thead>
                <th>Tarea</th>
                <th>% Tiempo</th>
              </thead>
              <tbody>
                <% @pos_functions.each do |function| %>
                  <tr>
                    <td>
                      <div>
                        <p>
                          <%= function.name %>
                        </p>
                      </div>
                    </td>
                    <td>
                      <input class="form-control" style="width: 100px;" type="number" name="time_per_<%= function.id %>" id="survey-input-<%= function.id %>">
                      <input type="hidden" class="form-control input-sm task" type="text" id="inputSmall_<%= function.id %>" value="<%= function.id %>" name="function_id_<%= function.id %>">
                      <input type="hidden" value="<%= form_authenticity_token() %>" name="authenticity_token"/>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
  
        <!-- other tasks form -->
        <div class="form-group">
          <div class="row">
            <label class="col-lg-12 control-label">Otras tareas realizadas: </label>
          </div>
          <div class="row">
            <table class="table table-striped table-hover ">
              <thead>
                <th>Tarea</th>
                <th>% Tiempo</th>
              </thead>
              <tbody id="other-tasks">
                <!--<tr>
                  <td>
                    <td>
                      <input class="form-control input-sm task" type="text" id="inputSmall" placeholder="Otra tarea">
                    </td>
                  </td>
                  <td>
                    <input class="form-control" style="width: 100px;" type="number" name="time_per_">
                  </td>
                </tr>-->
              </tbody>
            </table>
          </div>
          <div class="col-md-12">
            <div class="col-sm-8"></div>
            <div class="col-md-2"><div id="add-task-box"><button class="btn btn-primary pull-right" type="button" id="add-task">Añadir tarea</button></div></div>
            <div class="col-md-2"><div id="remove-task-box"><button class="btn btn-primary pull-right" type="button" id="remove-task">Eliminar tarea</button></div></div>
          </div>        
        </div>
      </fieldset>
      <hr>
      <div class="col-md-12">
        <input type="hidden" id="positionId" name="id" value="<%= @position.id %>" />
        <%= link_to(content_tag(:button, 'Cancelar', class: 'btn btn-primary', title: 'Cancelar'), action: 'reset_responses', id: @position.id) %>
        <button class="btn btn-success save-response" type="submit" onclick='return formCheck();'>Confirmar</button>
      </div>
    </form>
  </div>
</div>

<script>
    $("#errorTagCont").hide();
    $("#remove-task-box").hide();

    function formCheck() {
      validData = true;
      percSum = 0;
      $.each($("input[name^='time_per_']"), function( index, value ) {
        if (value.value == "" || !$.isNumeric(value.value)) {
          validData = false;
          showError("Debe responder todas las preguntas con formato numérico");
        } else {
          percSum = percSum + parseInt(value.value);
        }
      });
      if (validData && percSum != 100) {
        validData = false;
        showError("El total de porcentajes de tiempo debe sumar 100%");
      }
      return validData;
    }

    function showError(message) {
      $("#errorTag").html(message);
      $(window).scrollTop(0);
      $("#errorTagCont").show();
    }

    // js for other-tasks inputs

    var numOthTasks = 1000;

    $("#add-task").click(function() {
      if($(".task-row").length < 3) {
        numOthTasks++;
        taskTemplate = '<tr class="task-row"><td style="width: 100%;"><input class="form-control input-sm" type="text" id="inputSmall" name="other_task_'+numOthTasks+'" placeholder="Otra tarea" required></td><td><input class="form-control input-sm" style="width: 100px;" type="number" name="time_per_'+numOthTasks+'" id="survey-input-'+numOthTasks+'"></td></tr>'
        $("#other-tasks").append(taskTemplate);
        $("#remove-task-box").show();
        if($(".task-row").length == 3) {
          $("#add-task-box").hide();
        }
      }
    })

    $("#remove-task").click(function() {
      if($(".task-row").length >= 1) {
        numOthTasks--;
        $(".task-row").last().remove();
        $("#add-task-box").show();
        if ($(".task-row").length < 1) {
          $("#remove-task-box").hide();
        }
      }
    })

    // modal instructions

    var acc = document.getElementsByClassName("accordion");
    var i;

    for (i = 0; i < acc.length; i++) {
      acc[i].onclick = function() {
        this.classList.toggle("active");
        var panel = this.nextElementSibling;
        if (panel.style.maxHeight){
          panel.style.maxHeight = null;
        } else {
          panel.style.maxHeight = panel.scrollHeight + "px";
        }
      }
    }
</script>
